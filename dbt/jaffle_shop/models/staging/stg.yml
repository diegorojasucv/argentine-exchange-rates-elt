version: 2

models:
  - name: stg_exchange_rates_cripto_usdt_ars
    description: >
      Stage with the necessary transformations to have the USDT/ARS exchange rates.
    data_tests:
      - dbt_utils.recency:
          datepart: minute
          field: extracted_ars_at
          interval: 30
          config:
            severity: warn
            store_failures: true
            schema: tests_failures
    columns:
      - name: exchange_name
        description: "Names of the exchange rates."
        data_type: TEXT
        data_tests:
          - not_null
      - name: indicator_description
        description: "Description of the indicator."
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: source_reference
        description: "Source of data (e.g BCRA, Criptoya)"
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: bid_price
        description: "Sale price reported by the exchange, excluding fees."
        data_type: FLOAT
        data_tests:
          - not_null
      - name: total_bid_price
        description: "Final sale price including transfer and trade fees"
        data_type: FLOAT
        data_tests:
          - not_null
      - name: ask_price
        description: "Purchase price reported by the exchange, excluding fees"
        data_type: FLOAT
        data_tests:
          - not_null
      - name: total_ask_price
        description: "Final purchase price including transfer and trade fees."
        data_type: FLOAT
        data_tests:
          - not_null
      - name: updated_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
      - name: extracted_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null

  - name: stg_exchange_rates_mep_usd_ars
    description: >
      Stage with the necessary transformations to have the MEP exchange rates.
    data_tests:
      - dbt_utils.recency:
          datepart: minute
          field: extracted_ars_at
          interval: 30
          config:
            severity: warn
    columns:
      - name: exchange_name
        description: "Names of type of MEP."
        data_type: TEXT
        data_tests:
          - not_null
      - name: indicator_description
        description: "Description of the indicator."
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: source_reference
        description: "Source of data (e.g BCRA, Criptoya)"
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: total_bid_price
        description: "Final sale price including transfer and trade fees"
        data_type: FLOAT
        data_tests:
          - not_null
      - name: updated_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
      - name: extracted_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
  - name: stg_exchange_rates_other_usd_ars
    description: >
      Stage with the necessary transformations to have the other exchange rates.
    data_tests:
      - dbt_utils.recency:
          datepart: minute
          field: extracted_ars_at
          interval: 30
          config:
            severity: warn
    columns:
      - name: exchange_name
        description: "Names of the exchange rates."
        data_type: TEXT
        data_tests:
          - not_null
      - name: indicator_description
        description: "Description of the indicator."
        data_type: TEXT
        data_tests:
          - not_null
      - name: source_reference
        description: "Source of data (e.g BCRA, Criptoya)"
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: total_bid_price
        description: "Final sale price including transfer and trade fees"
        data_type: FLOAT
        data_tests:
          - not_null
      - name: total_ask_price
        description: "Final purchase price including transfer and trade fees."
        data_type: FLOAT
        data_tests:
          - not_null
      - name: updated_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
      - name: extracted_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
  - name: stg_exchange_rates_official_usd_ars
    description: >
      Stage with the necessary transformations to have the official exchange rates.
    data_tests:
      - dbt_utils.recency:
          datepart: minute
          field: extracted_ars_at
          interval: 30
          config:
            severity: warn
    columns:
      - name: exchange_name
        description: "Names of the exchange rates."
        data_type: TEXT
        data_tests:
          - not_null
      - name: indicator_description
        description: "Description of the indicator."
        data_type: TEXT
        data_tests:
          - not_null
      - name: source_reference
        description: "Source of data (e.g BCRA, Criptoya)"
        data_type: TEXT
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: total_bid_price
        description: "Final sale price including transfer and trade fees"
        data_type: FLOAT
        data_tests:
          - not_null
      - name: updated_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null
      - name: extracted_ars_at
        description: "Timestamp when the data was last updated."
        data_type: TIMESTAMP_TZ
        data_tests:
          - not_null

unit_tests:
  - name: test_avg_and_date_mep_model
    description: "Check if my partitioned average and date calculations work correctly."
    model: stg_exchange_rates_mep_usd_ars
    given:
      - input: source('redshift_source', 'raw_mep_ars_prices')
        rows:
          - {mep_name: 'mep al30 ci',     total_bid_price: 1215,  extracted_at: '2024-09-11 21:24:19'}
          - {mep_name: 'mep al30 ci',     total_bid_price: 1247,  extracted_at: '2024-09-11 21:24:19'}
          - {mep_name: 'mep al30 24 hs',  total_bid_price: 1250,  extracted_at: '2024-09-12 21:24:19'}
          - {mep_name: 'mep al30 24 hs',  total_bid_price: 1260,  extracted_at: '2024-09-12 21:24:19'}
    expect:
        rows:
          - {exchange_name: 'mep al30 ci',    total_bid_price: 1215,  extracted_ars_at: '2024-09-11 18:24:19', avg_total_bid_price: 1231}
          - {exchange_name: 'mep al30 ci',    total_bid_price: 1247,  extracted_ars_at: '2024-09-11 18:24:19', avg_total_bid_price: 1231}
          - {exchange_name: 'mep al30 24 hs', total_bid_price: 1250,  extracted_ars_at: '2024-09-12 18:24:19', avg_total_bid_price: 1255}
          - {exchange_name: 'mep al30 24 hs', total_bid_price: 1260,  extracted_ars_at: '2024-09-12 18:24:19', avg_total_bid_price: 1255}

  - name: test_avg_and_date_official_model
    description: "Check if my partitioned average and date calculations work correctly."
    model: stg_exchange_rates_official_usd_ars
    given:
      - input: source('redshift_source', 'raw_bcra_indicators')
        rows:
          - {indicator_id: '4',  total_bid_price: 1215,  extracted_at: '2024-09-11 21:24:19'}
          - {indicator_id: '4',  total_bid_price: 1247,  extracted_at: '2024-09-11 21:24:19'}
          - {indicator_id: '4',  total_bid_price: 1250,  extracted_at: '2024-09-12 21:24:19'}
          - {indicator_id: '4',  total_bid_price: 1260,  extracted_at: '2024-09-12 21:24:19'}
    expect:
        rows:
          - {exchange_name: "Official Retailer Dollar",   source_reference: 'BCRA', total_bid_price: 1215,  extracted_ars_at: '2024-09-11 18:24:19', avg_total_bid_price: 1231}
          - {exchange_name: "Official Retailer Dollar",   source_reference: 'BCRA', total_bid_price: 1247,  extracted_ars_at: '2024-09-11 18:24:19', avg_total_bid_price: 1231}
          - {exchange_name: "Official Retailer Dollar",   source_reference: 'BCRA', total_bid_price: 1250,  extracted_ars_at: '2024-09-12 18:24:19', avg_total_bid_price: 1255}
          - {exchange_name: "Official Retailer Dollar",   source_reference: 'BCRA', total_bid_price: 1260,  extracted_ars_at: '2024-09-12 18:24:19', avg_total_bid_price: 1255}

  - name: test_avg_and_date_other_model
    description: "Check if my partitioned average and date calculations work correctly."
    model: stg_exchange_rates_other_usd_ars
    given:
      - input: source('redshift_source', 'raw_other_ars_prices')
        rows:
          - {exchange_name: 'ahorro',   total_ask_price: 1220, total_bid_price: 1210,  extracted_at: '2024-09-11 21:24:19'}
          - {exchange_name: 'tarjeta',  total_ask_price: 1230, total_bid_price: 1220,  extracted_at: '2024-09-11 21:24:19'}
          - {exchange_name: 'blue',     total_ask_price: 1240, total_bid_price: 1230,  extracted_at: '2024-09-11 21:24:19'}
          - {exchange_name: 'ahorro',   total_ask_price: 1250, total_bid_price: 1240,  extracted_at: '2024-09-12 21:24:19'}
          - {exchange_name: 'tarjeta',  total_ask_price: 1260, total_bid_price: 1250,  extracted_at: '2024-09-12 21:24:19'}
          - {exchange_name: 'blue',     total_ask_price: 1270, total_bid_price: 1260,  extracted_at: '2024-09-12 21:24:19'}
    expect:
        rows:
          - {exchange_name: "Saving",        source_reference: 'Criptoya - USD', total_ask_price: 1220, total_bid_price: 1210, extracted_ars_at: '2024-09-11 18:24:19', avg_total_ask_price: 1230, avg_total_bid_price: 1220}
          - {exchange_name: "Tourist",       source_reference: 'Criptoya - USD', total_ask_price: 1230, total_bid_price: 1220, extracted_ars_at: '2024-09-11 18:24:19', avg_total_ask_price: 1230, avg_total_bid_price: 1220}
          - {exchange_name: 'Black Market',  source_reference: 'Criptoya - USD', total_ask_price: 1240, total_bid_price: 1230, extracted_ars_at: '2024-09-11 18:24:19', avg_total_ask_price: 1230, avg_total_bid_price: 1220}
          - {exchange_name: "Saving",        source_reference: 'Criptoya - USD', total_ask_price: 1250, total_bid_price: 1240, extracted_ars_at: '2024-09-12 18:24:19', avg_total_ask_price: 1260, avg_total_bid_price: 1250}
          - {exchange_name: "Tourist",       source_reference: 'Criptoya - USD', total_ask_price: 1260, total_bid_price: 1250, extracted_ars_at: '2024-09-12 18:24:19', avg_total_ask_price: 1260, avg_total_bid_price: 1250}
          - {exchange_name: 'Black Market',  source_reference: 'Criptoya - USD', total_ask_price: 1270, total_bid_price: 1260, extracted_ars_at: '2024-09-12 18:24:19', avg_total_ask_price: 1260, avg_total_bid_price: 1250}
